<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加工条件コンサルタント AI (Pro)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        /* Modal Backdrop Blur */
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MANUFACTURERS = [
            'サンドビック (Sandvik)',
            'OSG',
            '三菱マテリアル (Mitsubishi Materials)',
            '京セラ (Kyocera)',
            '住友電工 (Sumitomo)',
            'イスカル (Iscar)',
            'タンガロイ (Tungaloy)',
            'ユニオンツール (Union Tool)',
            '不二越 (NACHI)',
            'BIG大昭和精機 (BIG DAISHOWA)',
            'イワタツール (IWATA TOOL)',
            '栄工舎 (Eiko-sha)',
            'アサヒ工具 (Asahi Tool)',
            'その他 (Other)'
        ];

        // Icon Component using Lucide
        const Icon = ({ name, size = 20, className }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    setIconData(window.lucide.icons[name]);
                }
            }, [name]);
            if (!iconData) return null;
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {iconData.map((element, index) => {
                        const [tag, attrs] = element;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // Disclaimer Modal Component
        const DisclaimerModal = ({ onAccept }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-fade-in-up">
                        <div className="bg-amber-500 p-4 flex items-center space-x-3 text-white">
                            <Icon name="TriangleAlert" size={24} />
                            <h2 className="text-lg font-bold">重要：免責事項と利用規約</h2>
                        </div>
                        <div className="p-6 space-y-4 text-sm text-slate-600 max-h-[60vh] overflow-y-auto">
                            <p className="font-bold text-slate-800">本アプリケーションを使用する前に、必ず以下の内容をご確認ください。</p>
                            <ul className="list-disc pl-5 space-y-2">
                                <li>
                                    <strong>参考値としての利用:</strong> 本アプリが提示する加工条件（回転速度、送り速度など）は、AIがWeb上の情報に基づき算出した「参考値」です。実際の加工結果を保証するものではありません。
                                </li>
                                <li>
                                    <strong>安全確認の義務:</strong> 提示された条件を実際の機械に入力する際は、必ず工具メーカーの公式カタログと照らし合わせ、オペレーター自身の責任で安全を確認してください。
                                </li>
                                <li>
                                    <strong>免責:</strong> 本アプリの使用により生じた工具破損、機械故障、怪我、利益損失などのいかなる損害についても、開発者および提供者は一切の責任を負いません。
                                </li>
                                <li>
                                    <strong>AIの特性:</strong> AIは誤った情報（ハルシネーション）を生成する可能性があります。必ず出典元のURLを確認してください。
                                </li>
                            </ul>
                        </div>
                        <div className="p-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                            <button 
                                onClick={onAccept}
                                className="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-xl transition-all flex items-center space-x-2"
                            >
                                <span>上記に同意して利用する</span>
                                <Icon name="ArrowRight" size={18} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const generateContent = async (apiKey, prompt) => {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ google_search: {} }],
                generationConfig: {
                    temperature: 0.1
                }
            };

            const MAX_RETRIES = 5;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            for (let i = 0; i <= MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        if (i === MAX_RETRIES) throw new Error("APIの利用制限を超えました。しばらく時間をおいてから再試行してください。");
                        const backoffTime = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await delay(backoffTime);
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'APIリクエストに失敗しました');
                    }

                    const data = await response.json();
                    const candidate = data.candidates?.[0];
                    if (!candidate) throw new Error('AIからの応答がありません');

                    const text = candidate.content?.parts?.[0]?.text || '';
                    
                    let jsonContent = '';
                    const fence = "`" + "`" + "`";
                    const pattern = fence + "(?:json)?\\s*([\\s\\S]*?)\\s*" + fence;
                    const codeBlockRegex = new RegExp(pattern);
                    const codeBlockMatch = text.match(codeBlockRegex);
                    
                    if (codeBlockMatch) {
                        jsonContent = codeBlockMatch[1];
                    } else {
                        const firstBrace = text.indexOf('{');
                        const lastBrace = text.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            jsonContent = text.substring(firstBrace, lastBrace + 1);
                        } else {
                            jsonContent = text;
                        }
                    }

                    let parsedData;
                    try {
                        parsedData = JSON.parse(jsonContent.trim());
                    } catch (e) {
                        throw new Error("データの解析に失敗しました。");
                    }

                    const groundingChunks = candidate.groundingMetadata?.groundingChunks || [];
                    const sources = groundingChunks
                        .filter(chunk => chunk.web)
                        .map(chunk => ({ title: chunk.web.title, uri: chunk.web.uri }));

                    return { 
                        data: parsedData, 
                        sources: Array.from(new Map(sources.map(item => [item.uri, item])).values()) 
                    };

                } catch (error) {
                    if (i === MAX_RETRIES) throw error;
                    const backoffTime = Math.pow(2, i) * 1000;
                    await delay(backoffTime);
                    continue;
                }
            }
        };

        const Sidebar = ({ isOpen, onClose, apiKey, setApiKey, resetApp }) => {
            const [inputKey, setInputKey] = useState(apiKey);
            const [isValidating, setIsValidating] = useState(false);
            const [status, setStatus] = useState(null);

            const handleSave = () => {
                if (!inputKey) return;
                setIsValidating(true);
                // In a real app, validate key with a dummy request here
                setTimeout(() => {
                    setApiKey(inputKey);
                    setStatus('success');
                    setIsValidating(false);
                }, 400);
            };

            return (
                <div className={`fixed inset-y-0 left-0 z-30 w-80 bg-slate-900 text-slate-100 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static shadow-xl`}>
                    <div className="flex items-center justify-between h-16 px-6 bg-slate-950 border-b border-slate-800">
                        <div className="flex items-center space-x-2 font-bold text-lg text-blue-400">
                            <Icon name="Cpu" />
                            <span>PMC AI <span className="text-xs font-normal text-slate-500 ml-1">Pro</span></span>
                        </div>
                        <button onClick={onClose} className="md:hidden text-slate-400"><Icon name="X" /></button>
                    </div>
                    <div className="p-6 space-y-8">
                        <div className="space-y-4">
                            <div className="flex items-center space-x-2 text-sm font-medium text-slate-400">
                                <Icon name="ShieldCheck" size={16} />
                                <span>API 設定 (クライアントサイド)</span>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p className="text-[10px] text-slate-400 leading-tight">
                                    セキュリティ: 入力されたAPIキーはブラウザ内にのみ保存され、Googleのサーバー以外へ送信されることはありません。
                                </p>
                            </div>
                            <input 
                                type="password" 
                                value={inputKey}
                                onChange={(e) => { setInputKey(e.target.value); setStatus(null); }}
                                placeholder="Gemini APIキーを入力"
                                className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all placeholder-slate-600"
                            />
                            <button 
                                onClick={handleSave}
                                disabled={!inputKey || isValidating}
                                className={`w-full py-2.5 rounded-lg text-sm font-bold transition-all shadow-lg ${status === 'success' ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50 disabled:cursor-not-allowed'}`}
                            >
                                {isValidating ? '検証中...' : status === 'success' ? '設定完了・利用可能' : 'キーを保存して有効化'}
                            </button>
                        </div>
                        
                        <div className="pt-4 border-t border-slate-800">
                            <button onClick={resetApp} className="w-full text-left px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white text-sm flex items-center space-x-3 transition-colors">
                                <Icon name="PlusCircle" size={18} /><span>新規計算を開始</span>
                            </button>
                            <a href="https://ai.google.dev/" target="_blank" rel="noreferrer" className="w-full text-left px-4 py-3 rounded-lg text-slate-500 hover:text-slate-400 text-xs flex items-center space-x-3 transition-colors mt-2">
                                <Icon name="ExternalLink" size={14} /><span>APIキーの取得 (Google AI)</span>
                            </a>
                        </div>

                        <div className="absolute bottom-6 left-6 right-6 text-[10px] text-slate-600 text-center">
                            Precision Machining Consultant<br/>
                            v2.0.0 Public Edition
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isDisclaimerAccepted, setIsDisclaimerAccepted] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [step, setStep] = useState(0); 
            const [manufacturer, setManufacturer] = useState('');
            const [modelNumber, setModelNumber] = useState('');
            const [toolMetadata, setToolMetadata] = useState(null);
            const [metadataSources, setMetadataSources] = useState([]);
            
            // Step 2 Inputs
            const [selectedMaterial, setSelectedMaterial] = useState('');
            const [isManualMaterial, setIsManualMaterial] = useState(false);
            const [selectedMethod, setSelectedMethod] = useState('');
            const [diameter, setDiameter] = useState(10);
            const [machiningDistance, setMachiningDistance] = useState(100);
            const [passCount, setPassCount] = useState(1);
            
            const [result, setResult] = useState(null);
            const [resultSources, setResultSources] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const resetApp = () => {
                setStep(0); setToolMetadata(null); setResult(null); 
                setManufacturer(''); setModelNumber(''); setError(null);
                setDiameter(10); setMachiningDistance(100); setPassCount(1);
                setIsManualMaterial(false);
                if (window.innerWidth < 768) setIsSidebarOpen(false);
            };

            const handleSearchTool = async () => {
                if (!apiKey) { setError("サイドバーでAPIキーを設定してください。"); return; }
                if (!manufacturer) { setError("メーカーを選択してください。"); return; }
                if (!modelNumber.trim()) { setError("型番または注文番号を入力してください。"); return; }
                setLoading(true); setError(null);
                
                const prompt = `Perform a targeted Google Search to find the OFFICIAL technical specifications for the cutting tool by "${manufacturer}". 
                The user provided identification: "${modelNumber}" (This could be a Model Name, Series Name, or specific Ordering Number/EDP Number).
                
                STRICT REQUIREMENTS FOR ACCURACY:
                1. **Data Source:** Extract information ONLY from the manufacturer's official catalogs or technical data sheets.
                2. **Materials:** List ONLY the recommended workpiece materials for this specific tool.
                3. **Methods:** List ONLY the machining operations (e.g., Side Milling, Slotting, Drilling).
                4. **Diameter:** Extract the EXACT diameter (DC) or the valid range (min-max). This is crucial for validation.
                5. **Output ONLY JSON inside markdown code block.**
                {
                    "materials": ["被削材1", "被削材2"],
                    "methods": ["加工方法1", "加工方法2"],
                    "diameter": {
                        "type": "fixed"|"range"|"unknown", 
                        "value": number (if fixed), 
                        "min": number (if range), 
                        "max": number (if range)
                    },
                    "description": "工具の特徴や仕様の日本語要約（注文番号に基づく詳細な特定結果を含む）"
                }`;

                try {
                    const { data, sources } = await generateContent(apiKey, prompt);
                    setToolMetadata(data);
                    setMetadataSources(sources);
                    
                    if (data.materials && data.materials.length > 0) {
                        setSelectedMaterial(data.materials[0]);
                        setIsManualMaterial(false);
                    } else {
                        setSelectedMaterial('');
                        setIsManualMaterial(true);
                    }

                    if (data.methods?.[0]) setSelectedMethod(data.methods[0]);
                    
                    if (data.diameter) {
                        if (data.diameter.type === 'fixed' && data.diameter.value) {
                            setDiameter(data.diameter.value);
                        } else if (data.diameter.type === 'range') {
                            setDiameter(data.diameter.min || data.diameter.value || 10);
                        } else if (data.diameter.value) {
                             setDiameter(data.diameter.value);
                        }
                    }
                    
                    setStep(1);
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const handleCalculate = async () => {
                if (!selectedMaterial) { setError("被削材を入力または選択してください。"); return; }
                if (diameter <= 0) { setError("工具径は正の数値を入力してください。"); return; }
                
                setLoading(true); setError(null);
                const prompt = `Act as an expert machining engineer. Calculate OPTIMAL cutting conditions.
                Input: Tool: ${manufacturer}, ID: ${modelNumber}, Material: ${selectedMaterial}, Method: ${selectedMethod}, Diameter: ${diameter}mm.
                
                **CRITICAL TASK: FULL DIMENSION EXTRACTION & INSERT CHECK**
                1. Extract ALL available tool dimensions from the latest catalog data (DC, DCONMS, LU, LCF, OAL/LF, SIG, PL, ZEFF/Z, ULDR, GAMO, BSG/ADINTMS, TCHA/TCDCON, GRADE, Pitch, LS etc.).
                2. **Determine if the tool is Indexable (uses inserts) or Solid.**
                   - Set 'isIndexable' to true ONLY if it requires replaceable inserts.
                   - Set 'isIndexable' to false for Solid Carbide, HSS, or Brazed tools.
                3. **INSERT SELECTION (Important):** If isIndexable is true, recommend the BEST specific insert grade and breaker/geometry SPECIFICALLY for the selected workpiece material ("${selectedMaterial}"). Do NOT suggest generic inserts if possible. Consider material hardness and chip control. If solid, 'recommendedInsert' MUST be null.

                Output ONLY JSON. Reasoning and coolant in Japanese.
                {
                    "vc": number, "fz": number, "z": number, "rpm": integer, "f": integer,
                    "isIndexable": boolean,
                    "recommendedInsert": "string or null", 
                    "reasoning": "AIによる計算根拠の解説（被削材に対応したチップ選定理由も含む）", 
                    "coolant": "推奨クーラント",
                    "dimensions": [
                        {"name": "工具径 (DC)", "value": "10.0 mm"},
                        {"name": "シャンク径 (DCONMS)", "value": "10.0 mm"},
                        ... add ALL found dimensions ...
                    ]
                }`;

                try {
                    const { data, sources } = await generateContent(apiKey, prompt);
                    setResult(data);
                    setResultSources(sources);
                    setStep(2);
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const getUniqueSources = () => {
                const allSources = [...metadataSources, ...resultSources];
                const uniqueMap = new Map();
                allSources.forEach(source => {
                    if (!uniqueMap.has(source.uri)) uniqueMap.set(source.uri, source);
                });
                return Array.from(uniqueMap.values());
            };

            return (
                <div className="flex h-screen bg-slate-100">
                    {!isDisclaimerAccepted && <DisclaimerModal onAccept={() => setIsDisclaimerAccepted(true)} />}
                    
                    <Sidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} apiKey={apiKey} setApiKey={setApiKey} resetApp={resetApp} />
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="md:hidden flex items-center justify-between px-6 py-4 bg-white border-b shadow-sm z-20">
                            <div className="flex items-center space-x-2 font-bold text-blue-600"><Icon name="Cpu" /><span>PMC AI Pro</span></div>
                            <button onClick={() => setIsSidebarOpen(true)}><Icon name="Menu" /></button>
                        </header>
                        <main className="flex-1 overflow-y-auto p-4 md:p-8 lg:p-12 relative">
                            {/* Background decoration */}
                            <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-50 to-transparent -z-10"></div>

                            <div className="max-w-5xl mx-auto space-y-10 pb-24">
                                <div className="text-center md:text-left">
                                    <h1 className="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">加工条件コンサルタント AI</h1>
                                    <p className="text-slate-500 mt-2 text-lg">AIがメーカー公式情報を瞬時に検索し、最適な切削条件をエンジニアリングします。</p>
                                </div>

                                {!apiKey && isDisclaimerAccepted && (
                                    <div className="bg-white border-l-4 border-amber-500 rounded-r-xl p-6 shadow-md flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6 animate-fade-in-up">
                                        <div className="bg-amber-100 p-3 rounded-full text-amber-600 flex-shrink-0">
                                            <Icon name="Key" size={24} />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-lg text-slate-800">APIキーが必要です</h3>
                                            <p className="text-slate-600 mt-1">
                                                利用を開始するには、Google Gemini APIキーの設定が必要です。<br/>
                                                左側のメニュー（モバイルの場合は左上のハンバーガーメニュー）から設定を行ってください。
                                            </p>
                                        </div>
                                    </div>
                                )}

                                {error && (
                                    <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex items-center space-x-3 text-red-700 font-medium animate-fade-in-up shadow-sm">
                                        <Icon name="AlertCircle" className="flex-shrink-0"/><span>{error}</span>
                                    </div>
                                )}

                                <section className={`bg-white rounded-2xl shadow-lg border border-slate-100 p-6 md:p-10 space-y-8 transition-all duration-500 ${step >= 0 ? 'opacity-100 transform translate-y-0' : 'opacity-50 transform translate-y-4 pointer-events-none'}`}>
                                    <div className="flex items-center space-x-3 border-b border-slate-100 pb-4">
                                        <div className="bg-blue-600 text-white p-2 rounded-lg"><Icon name="Search" size={20}/></div>
                                        <h2 className="font-bold text-xl text-slate-800">STEP 1. 工具情報の検索</h2>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="space-y-2">
                                            <label className="text-sm font-bold text-slate-500 uppercase tracking-wider">メーカー (Manufacturer)</label>
                                            <div className="relative">
                                                <select 
                                                    value={manufacturer} 
                                                    onChange={(e) => setManufacturer(e.target.value)} 
                                                    disabled={step > 0} 
                                                    className={`w-full bg-slate-50 border-2 rounded-xl p-4 text-base appearance-none focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all ${!manufacturer ? 'text-slate-400 border-slate-200' : 'text-slate-900 border-blue-500 bg-blue-50/30'}`}
                                                >
                                                    <option value="" disabled>メーカーを選択してください</option>
                                                    {MANUFACTURERS.map(m => <option key={m} value={m}>{m}</option>)}
                                                </select>
                                                <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400">
                                                    <Icon name="ChevronDown" size={16} />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-sm font-bold text-slate-500 uppercase tracking-wider">型番 / 注文番号 (Model / EDP)</label>
                                            <input 
                                                type="text" 
                                                value={modelNumber} 
                                                onChange={(e) => setModelNumber(e.target.value)} 
                                                disabled={step > 0} 
                                                placeholder="例: 460.1-1032-052A1-XM" 
                                                className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-base focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all placeholder-slate-300" 
                                            />
                                        </div>
                                    </div>
                                    
                                    {step === 0 && (
                                        <div className="flex justify-end pt-4">
                                            <button 
                                                onClick={handleSearchTool} 
                                                disabled={loading || !modelNumber || !manufacturer || !apiKey} 
                                                className="bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-slate-300 hover:shadow-xl transition-all flex items-center justify-center space-x-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none min-w-[200px]"
                                            >
                                                {loading ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Search" size={20} />}
                                                <span>スペックを検索</span>
                                            </button>
                                        </div>
                                    )}
                                </section>

                                {step >= 1 && toolMetadata && (
                                    <section className="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 md:p-10 space-y-8 animate-fade-in-up">
                                        <div className="flex items-center space-x-3 border-b border-slate-100 pb-4">
                                            <div className="bg-blue-600 text-white p-2 rounded-lg"><Icon name="Settings" size={20}/></div>
                                            <h2 className="font-bold text-xl text-slate-800">STEP 2. 加工要件の設定</h2>
                                        </div>
                                        
                                        <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 flex items-start space-x-4">
                                            <Icon name="Info" size={24} className="text-blue-600 mt-1 flex-shrink-0" />
                                            <div>
                                                <h4 className="font-bold text-blue-900 mb-1">AI Search Result</h4>
                                                <p className="text-sm text-blue-800 leading-relaxed">{toolMetadata.description}</p>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-500 uppercase tracking-wider">
                                                    被削材 {isManualMaterial && <span className="text-blue-500 bg-blue-50 px-2 py-0.5 rounded text-[10px] ml-1">手入力</span>}
                                                </label>
                                                {isManualMaterial ? (
                                                    <div className="relative">
                                                        <input 
                                                            type="text" 
                                                            value={selectedMaterial} 
                                                            onChange={(e) => setSelectedMaterial(e.target.value)} 
                                                            disabled={step > 1}
                                                            placeholder="例: SUS304, S45C"
                                                            className="w-full bg-white border-2 border-blue-400 rounded-xl p-3.5 text-sm focus:ring-4 focus:ring-blue-100 outline-none" 
                                                        />
                                                        {toolMetadata.materials?.length > 0 && (
                                                            <button 
                                                                onClick={() => {
                                                                    setIsManualMaterial(false);
                                                                    setSelectedMaterial(toolMetadata.materials[0]);
                                                                }}
                                                                disabled={step > 1}
                                                                className="absolute right-2 top-2 bottom-2 px-3 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors"
                                                            >
                                                                リストに戻す
                                                            </button>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="relative">
                                                        <select 
                                                            value={selectedMaterial} 
                                                            onChange={(e) => {
                                                                if (e.target.value === 'MANUAL_INPUT') {
                                                                    setIsManualMaterial(true);
                                                                    setSelectedMaterial('');
                                                                } else {
                                                                    setSelectedMaterial(e.target.value);
                                                                }
                                                            }} 
                                                            disabled={step > 1} 
                                                            className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3.5 text-sm appearance-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all"
                                                        >
                                                            {toolMetadata.materials?.map(m => <option key={m} value={m}>{m}</option>)}
                                                            <option value="MANUAL_INPUT">その他（手入力）</option>
                                                        </select>
                                                        <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400">
                                                            <Icon name="ChevronDown" size={16} />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-500 uppercase tracking-wider">加工方法</label>
                                                <div className="relative">
                                                    <select value={selectedMethod} onChange={(e) => setSelectedMethod(e.target.value)} disabled={step > 1} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3.5 text-sm appearance-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all">
                                                        {toolMetadata.methods?.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400">
                                                        <Icon name="ChevronDown" size={16} />
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-500 uppercase tracking-wider flex justify-between">
                                                    <span>工具径 (mm)</span>
                                                    {toolMetadata.diameter?.type === 'fixed' && <span className="text-blue-600 text-[10px] bg-blue-50 px-2 rounded">固定値</span>}
                                                </label>
                                                <input 
                                                    type="number" 
                                                    value={diameter} 
                                                    onChange={(e) => setDiameter(parseFloat(e.target.value))} 
                                                    disabled={step > 1 || toolMetadata.diameter?.type === 'fixed'} 
                                                    min={toolMetadata.diameter?.min}
                                                    max={toolMetadata.diameter?.max}
                                                    className={`w-full border-2 rounded-xl p-3.5 text-sm focus:ring-4 focus:ring-blue-100 outline-none transition-all ${toolMetadata.diameter?.type === 'fixed' ? 'bg-slate-100 border-slate-200 text-slate-500' : 'bg-white border-slate-200 focus:border-blue-500'}`} 
                                                />
                                                {toolMetadata.diameter?.type === 'range' && (
                                                    <p className="text-[10px] text-slate-400 text-right">推奨範囲: {toolMetadata.diameter.min} - {toolMetadata.diameter.max} mm</p>
                                                )}
                                            </div>

                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-500 uppercase tracking-wider">加工距離 (mm)</label>
                                                <input type="number" value={machiningDistance} onChange={(e) => setMachiningDistance(parseFloat(e.target.value))} disabled={step > 1} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all" />
                                            </div>

                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-slate-400 uppercase tracking-wider">加工回数 (パス)</label>
                                                <input type="number" value={passCount} onChange={(e) => setPassCount(parseInt(e.target.value))} disabled={step > 1} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all" />
                                            </div>
                                        </div>

                                        {step === 1 && (
                                            <div className="flex justify-end pt-6 space-x-4 border-t border-slate-100 mt-6">
                                                <button 
                                                    onClick={resetApp} 
                                                    className="px-6 py-3 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 font-medium transition-colors"
                                                >
                                                    キャンセル
                                                </button>
                                                <button 
                                                    onClick={handleCalculate} 
                                                    disabled={loading} 
                                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-200 hover:shadow-xl transition-all flex items-center space-x-2"
                                                >
                                                    {loading ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Play" size={18} fill="currentColor"/>}
                                                    <span>最適条件を算出</span>
                                                </button>
                                            </div>
                                        )}
                                    </section>
                                )}

                                {step === 2 && result && (
                                    <div className="space-y-8 animate-fade-in-up pb-10">
                                        
                                        {/* Main Result Cards */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            {/* RPM */}
                                            <div className="bg-white p-8 rounded-2xl border-b-4 border-b-slate-900 shadow-lg flex flex-col justify-between group hover:-translate-y-1 transition-transform duration-300">
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Rotation (S)</span>
                                                        <Icon name="RotateCw" size={20} className="text-slate-200 group-hover:text-slate-400 transition-colors" />
                                                    </div>
                                                    <div className="text-5xl font-black text-slate-900 tracking-tighter">
                                                        {result.rpm.toLocaleString()}
                                                        <span className="text-lg font-bold ml-1 text-slate-400 tracking-normal">min⁻¹</span>
                                                    </div>
                                                </div>
                                                <div className="mt-4 pt-4 border-t border-slate-100 flex justify-between text-xs font-mono text-slate-500">
                                                    <span>Vc: {result.vc} m/min</span>
                                                    <span>D: {diameter}mm</span>
                                                </div>
                                            </div>

                                            {/* Feed */}
                                            <div className="bg-white p-8 rounded-2xl border-b-4 border-b-blue-600 shadow-lg flex flex-col justify-between group hover:-translate-y-1 transition-transform duration-300">
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Feed Rate (F)</span>
                                                        <Icon name="MoveRight" size={20} className="text-blue-100 group-hover:text-blue-300 transition-colors" />
                                                    </div>
                                                    <div className="text-5xl font-black text-blue-600 tracking-tighter">
                                                        {result.f.toLocaleString()}
                                                        <span className="text-lg font-bold ml-1 text-slate-400 tracking-normal">mm/min</span>
                                                    </div>
                                                </div>
                                                <div className="mt-4 pt-4 border-t border-slate-100 flex justify-between text-xs font-mono text-slate-500">
                                                    <span>fz: {result.fz} mm/t</span>
                                                    <span>Z: {result.z}</span>
                                                </div>
                                            </div>

                                            {/* Time */}
                                            <div className="bg-slate-900 p-8 rounded-2xl shadow-xl flex flex-col justify-between group hover:-translate-y-1 transition-transform duration-300 relative overflow-hidden">
                                                <div className="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                                                    <Icon name="Timer" size={120} />
                                                </div>
                                                <div>
                                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">Est. Time</span>
                                                    <div className="text-4xl font-black text-white tracking-tighter mt-2">
                                                        {(() => {
                                                            const totalDistance = machiningDistance * passCount;
                                                            const timeInMinutes = totalDistance / result.f;
                                                            const mins = Math.floor(timeInMinutes);
                                                            const secs = Math.round((timeInMinutes - mins) * 60);
                                                            return `${mins}m ${secs}s`;
                                                        })()}
                                                    </div>
                                                </div>
                                                <div className="mt-4 pt-4 border-t border-slate-800 text-xs font-mono text-slate-400">
                                                    TOTAL DISTANCE: {(machiningDistance * passCount).toLocaleString()} mm
                                                </div>
                                            </div>
                                        </div>

                                        {/* Dimensions & Chip Info */}
                                        <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-8">
                                            <h3 className="font-bold text-slate-800 mb-6 text-sm flex items-center space-x-2 border-b border-slate-100 pb-4">
                                                <Icon name="Ruler" size={18} className="text-slate-400"/>
                                                <span>工具寸法情報 (TOOL DIMENSIONS)</span>
                                            </h3>
                                            
                                            <div className="space-y-8">
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                                    {result.dimensions?.map((dim, i) => (
                                                        <div key={i} className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col justify-center hover:border-blue-200 transition-colors">
                                                            <span className="text-[10px] text-slate-400 mb-1 font-bold uppercase tracking-wide">{dim.name}</span>
                                                            <span className="text-sm font-bold text-slate-800 break-words">{dim.value}</span>
                                                        </div>
                                                    ))}
                                                    {(!result.dimensions || result.dimensions.length === 0) && (
                                                        <div className="col-span-full text-center text-slate-400 text-sm py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                                                            寸法情報が取得できませんでした
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Chip Recommendation (Only if indexable) */}
                                                {result.isIndexable && (
                                                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100 shadow-sm">
                                                        <div className="flex items-start space-x-5">
                                                            <div className="bg-white p-3 rounded-xl text-blue-600 shadow-sm mt-1">
                                                                <Icon name="Layers" size={24} />
                                                            </div>
                                                            <div className="flex-1">
                                                                <h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider mb-2">Recommended Insert (推奨チップ)</h4>
                                                                <div>
                                                                    <div className="text-xl font-bold text-slate-900 font-mono tracking-tight">{result.recommendedInsert || "No Data"}</div>
                                                                    <div className="mt-2 text-xs text-blue-700 font-medium">
                                                                        ※被削材「{selectedMaterial}」および加工法に基づきAIが選定
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Reasoning & Source */}
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="bg-white rounded-2xl border border-slate-100 p-8 shadow-sm">
                                                <h3 className="font-bold flex items-center space-x-2 text-slate-800 mb-4 text-sm">
                                                    <Icon name="MessageSquare" size={18} className="text-blue-500"/>
                                                    <span>AIエンジニアの技術解説</span>
                                                </h3>
                                                <div className="space-y-4">
                                                    <p className="text-sm text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-xl">{result.reasoning}</p>
                                                    <div className="flex items-center space-x-2 text-sm font-semibold text-slate-700 bg-blue-50/50 p-3 rounded-lg border border-blue-100">
                                                        <Icon name="Droplets" size={16} className="text-blue-500"/>
                                                        <span>推奨クーラント: {result.coolant}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-2xl border border-slate-100 p-8 shadow-sm flex flex-col">
                                                <h3 className="font-bold text-slate-800 mb-4 text-sm flex items-center space-x-2">
                                                    <Icon name="Globe" size={18} className="text-slate-400"/>
                                                    <span>参照元・情報ソース</span>
                                                </h3>
                                                <div className="flex-1 overflow-y-auto max-h-[200px] pr-2 space-y-2 custom-scrollbar">
                                                    {getUniqueSources().map((s, i) => (
                                                        <a key={i} href={s.uri} target="_blank" rel="noopener noreferrer" className="p-3 text-xs bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-100 flex items-center justify-between group transition-colors">
                                                            <span className="text-slate-600 group-hover:text-blue-600 font-medium truncate pr-4">{s.title}</span>
                                                            <Icon name="ExternalLink" size={12} className="text-slate-300 group-hover:text-blue-400 flex-shrink-0" />
                                                        </a>
                                                    ))}
                                                    {getUniqueSources().length === 0 && (
                                                        <div className="h-full flex items-center justify-center text-xs text-slate-400 text-center italic p-4">
                                                            特定の外部ソースリンクは生成されませんでしたが、<br/>AIの学習済み知識ベースおよび一般的な技術データに基づいています。
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex justify-center pt-4">
                                            <button 
                                                onClick={resetApp} 
                                                className="bg-slate-900 text-white font-bold py-4 px-12 rounded-full hover:bg-slate-800 shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 flex items-center space-x-2"
                                            >
                                                <Icon name="RotateCcw" size={18} />
                                                <span>新しい計算を開始する</span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
